import { DENDRON_COMMANDS } from "../constants";
import { BasicCommand } from "./base";
import { VSCodeUtils } from "../utils";
import { DNodeUtils, NoteProps } from "@dendronhq/common-all";
import { getEngine } from "../workspace";

type CommandOpts = {};

type CommandOutput = CommandOpts;

export class InsertNoteIndexCommand extends BasicCommand<
  CommandOpts,
  CommandOutput
> {
  key = DENDRON_COMMANDS.INSERT_NOTE_INDEX.key;

  genNoteIndex(notes: NoteProps[], opts: {
    marker?: boolean
  }) {
    const listItems = notes.map((note) => `- [[${note.title}\|${note.fname}]]`)
    let payload = [
      "## Index",
      listItems.join("\n"),
    ];
    if (opts.marker) {
      payload = [
        "<!-- Autogenerated Index Start -->",
        ...payload,
        "<!-- Autogenerated Index End -->"
      ];
    }
    return payload.join("\n");
  }

  async execute(opts: CommandOpts) {
    const ctx = "InsertNoteIndexCommand";
    this.L.info({ ctx, msg: "execute", opts });
    // get open note's prop
    const editor = VSCodeUtils.getActiveTextEditor()!;
    const activeNote = VSCodeUtils.getNoteFromDocument(editor.document)!;
    // list direct child
    const engine = getEngine();
    const children = DNodeUtils.getChildren(activeNote, { nodeDict: engine.notes });
    console.log({children});
    // format fname of child into markdown list of wikilinks
    const noteIndex = this.genNoteIndex(children, {marker: true});
    // insert at position
    const current = editor.selection;
    await editor.edit((builder) => {
      builder.insert(current.start, noteIndex);
    });
    return opts;
  }
}
